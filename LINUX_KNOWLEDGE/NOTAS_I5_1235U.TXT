******ACTUALIZAR EL KERNEL (SI NO LO HACES, LOS E-CORES PROVOCAN MICRO-STUTTERING Y HABRÍA QUE DESACTIVARLOS EN LA BIOS)*******

-Instalamos dependencias previas:

apt-get install lsb-release apt-transport-https ca-certificates curl --no-install-recommends

-Bajamos la firma del repo:
curl -fSsL https://pkgs.zabbly.com/key.asc | gpg --dearmor | sudo tee /usr/share/keyrings/linux-zabbly.gpg > /dev/null

-Creamos /etc/apt/sources.list.d/linux-zabbly.list con el contenido:
deb [arch=amd64 signed-by=/usr/share/keyrings/linux-zabbly.gpg] https://pkgs.zabbly.com/kernel/stable bookworm main

-Actualizamos los metadatos de apt:
apt-get update

-Instalamos el último kernel de zabbly:
apt install linux-zabbly

******AJUSTES EN LA BIOS***************

La idea es tener frecuencia fija de la CPU (mientras se ejecutan cosas al menos) y poco jittering:

-En la BIOS:
Desactiva los Efficiency Cores, el Hyper-Threading, Intel(R) SpeedStep, Race To Halt, Energy Efficient Turbo,
C-States, (O bien sólo los Enhanced C-States (es lo que llaman C1E) y todo lo que hay debajo),
y todas las opciones de eficiencia que veas.
Desactiva el Legacy USB.
En "GT - Power Management Control" pon "Maximum GT frequency" a 1200Mhz.
COSAS QUE DEBES DEJAR ACTIVAS EN LA BIOS:
-Turbo Mode: Sin esto, Linux no puede pasar de 1.3GHz (La CPU queda limitada a 1.3GHz o "velocidad nominal" hagas lo que hagas).
-Intel Speed Shift: Sin esto, Linux no puede manejar los P-States (Nunca puede subir de 2.5GHz hagas lo que hagas).

-En la línea de parámetros del kernel pasamos: intel_idle.max_cstate=0 processor.max_cstate=0
(Eso se hace editando /etc/default/grub y luego haciendo "update-grub").
NO le pasamos idle=poll o idle=halt porque la idea es que cuando la CPU está idle, pueda bajarse de velocidad usando los P-States,
pero como los C-States sí que los desactivamos, no puede desactivar cachés y cosas así.
Puedes observar las frecuencias de la CPU con: watch -n1 "grep \"^[c]pu MHz\" /proc/cpuinfo"
Y verás que sí que baja mucho cuando no hay nada ejecutándose, pero que una vez que hay cosas ejecutándose no baja de la velocidad
turbo máxima que le hayas puesto en dietpi-config. 

-En dietpi-config, entra en PERFORMANCE OPTIONS y pon:
Governor a performance, Intel Turbo ON, y CPU Frequency Limits: MAX=80% MIN=80%
(Esto sería para emular Saturn bien con max_swapchain a 3: si quieres Saturn con max_swapchain a 2, tienes que poner ambos valores a 100%,
pero eso recalienta la CPU por encima de 72 grados al cabo de un rato). 

******Sonido en Linux************

Tenemos que hacerl a mano (incluso si usas DietPi, la utilidad dietpi-config nos permite seleccionar el hardware de audio pero por número,
así que no nos vale para nada porque el número cambia entre reinicios, hay que seleccionar por nombre).

-Instalamos alsa-utils:
apt-get install alsa-utils

POR HDMI:
Cemos qué cards y devices hay con: aplay -l
Vemos que el HDMI 0, que es el que suena en este cacharro, aparece listado como:
card 0: PCH [HDA Intel PCH], device 3: HDMI 0 [XG2401 SERIES]

Lo probamos con speaker-test:
speaker-test -c2 -D hw:PCH,3

Así que ahora creamos /etc/asound.conf donde especificamos el nombre de la CARD y el número de DEVICE:
(OJO: NO debemos especificar la CARD por número, porque el número cambia entre reinicios).

pcm.!default {                                                                                                 
        type hw                                                                                                
        card PCH                                                                                               
        device 3                                                                                               
}                                                                                                              
                                                                                                               
ctl.!default {                                                                                                 
        type hw                                                                                                
        card PCH                                                                                               
}

...Y ya suena todo lo de ALSA por defecto por el HDMI!

POR JACK TRASERO:

speaker-test -c2 -D hw:HID,0

Con lo que en /etc/asound.conf tendríamos:
pcm.!default {                                                                                                 
        type hw                                                                                                
        card HID                                                                                               
        device 0                                                                                               
}                                                                                                              
                                                                                                               
ctl.!default {                                                                                                 
        type hw                                                                                                
        card HID                                                                                               
}
*****CONFIGURACIÓN DE AUDIO/VIDEO EN RETROARCH******
	
-Video: VULKAN con SWAPCHAIN a 2
-Audio: ALSATHREAD con 44100Hz y LATENCY a 48 

*****COMPROBAR GOVERNOR DE LA CPU*********

Lo más fácil:
watch -n1 "grep \"^[c]pu MHz\" /proc/cpuinfo"

O BIEN:
cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor
cat /sys/devices/system/cpu/cpu1/cpufreq/scaling_governor
cat /sys/devices/system/cpu/cpu2/cpufreq/scaling_governor
...etc

*****LIMPIEZA DE SISTEMA******

Estas cosas se pueden desinstalar y aún así wayland funciona como servicio sin problemas:
apt-get purge dbus
